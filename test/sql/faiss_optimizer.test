# name: test/sql/faiss_optimizer.test
# description: Test ANN optimizer rewrite with FAISS indexes
# group: [faiss]

require ann

statement ok
CREATE TABLE docs (id INT, embedding FLOAT[3]);

statement ok
INSERT INTO docs VALUES
  (1, [1.0, 0.0, 0.0]),
  (2, [0.0, 1.0, 0.0]),
  (3, [0.0, 0.0, 1.0]),
  (4, [0.5, 0.5, 0.0]),
  (5, [0.0, 0.5, 0.5]);

statement ok
CREATE INDEX faiss_idx ON docs USING FAISS (embedding);

# ========================================
# ORDER BY array_distance LIMIT k â†’ FAISS index scan
# ========================================

query IR
SELECT id, array_distance(embedding, [1.0, 0.0, 0.0]::FLOAT[3]) AS dist
FROM docs
ORDER BY dist, id
LIMIT 3;
----
1	0.0
4	0.70710677
5	1.2247449

# Different query vector
query IR
SELECT id, array_distance(embedding, [0.0, 1.0, 0.0]::FLOAT[3]) AS dist
FROM docs
ORDER BY dist
LIMIT 2;
----
2	0.0
4	0.70710677

# ========================================
# ORDER BY with WHERE filter
# ========================================

statement ok
CREATE TABLE products (id INT, category VARCHAR, embedding FLOAT[3]);

statement ok
INSERT INTO products VALUES
  (1, 'A', [1.0, 0.0, 0.0]),
  (2, 'A', [0.9, 0.1, 0.0]),
  (3, 'B', [0.0, 1.0, 0.0]),
  (4, 'B', [0.0, 0.9, 0.1]),
  (5, 'A', [0.5, 0.5, 0.0]);

statement ok
CREATE INDEX prod_faiss ON products USING FAISS (embedding);

query I
SELECT id
FROM products
WHERE category = 'A'
ORDER BY array_distance(embedding, [1.0, 0.0, 0.0]::FLOAT[3])
LIMIT 2;
----
1
2

# ========================================
# ORDER BY DESC should NOT rewrite (negative test)
# Descending order is not meaningful for distance search
# ========================================

query IR
SELECT id, array_distance(embedding, [1.0, 0.0, 0.0]::FLOAT[3]) AS dist
FROM docs
ORDER BY dist DESC, id
LIMIT 2;
----
2	1.4142135
3	1.4142135

# ========================================
# Multiple ORDER BY columns should NOT rewrite
# ========================================

query IRI
SELECT id, array_distance(embedding, [1.0, 0.0, 0.0]::FLOAT[3]) AS dist, id AS id2
FROM docs
ORDER BY dist, id2
LIMIT 2;
----
1	0.0	1
4	0.70710677	4

# ========================================
# Cosine similarity should NOT rewrite on L2 index (issue #28)
# The optimizer must not use an L2 index for cosine queries
# ========================================

query IR
SELECT id, array_cosine_similarity(embedding, [1.0, 0.0, 0.0]::FLOAT[3]) AS sim
FROM docs
ORDER BY sim
LIMIT 3;
----
2	0.0
3	0.0
5	0.0

# Verify EXPLAIN shows no ANN_INDEX_SCAN for cosine on L2 index
query II
EXPLAIN SELECT id, array_cosine_similarity(embedding, [1.0, 0.0, 0.0]::FLOAT[3]) AS sim
FROM docs ORDER BY sim LIMIT 2;
----
physical_plan	<REGEX>:.*ORDER_BY.*

# ========================================
# Inner product should NOT rewrite on L2 index
# ========================================

query II
EXPLAIN SELECT id, array_inner_product(embedding, [1.0, 0.0, 0.0]::FLOAT[3]) AS ip
FROM docs ORDER BY ip LIMIT 2;
----
physical_plan	<REGEX>:.*ORDER_BY.*

# ========================================
# array_distance on IP index should NOT rewrite
# ========================================

statement ok
CREATE TABLE ip_docs (id INT, embedding FLOAT[3]);

statement ok
INSERT INTO ip_docs SELECT i, [random()::FLOAT, random()::FLOAT, random()::FLOAT] FROM range(100) t(i);

statement ok
CREATE INDEX ip_opt_idx ON ip_docs USING FAISS (embedding) WITH (metric = 'IP');

# L2 distance on IP index should NOT rewrite
query II
EXPLAIN SELECT id, array_distance(embedding, [1.0, 0.0, 0.0]::FLOAT[3]) AS dist
FROM ip_docs ORDER BY dist LIMIT 2;
----
physical_plan	<REGEX>:.*ORDER_BY.*

statement ok
DROP INDEX ip_opt_idx;

statement ok
DROP TABLE ip_docs;

# ========================================
# EXPLAIN should show index type (issue #29)
# ========================================

statement ok
CREATE TABLE explain_docs (id INT, embedding FLOAT[3]);

statement ok
INSERT INTO explain_docs SELECT i, [random()::FLOAT, random()::FLOAT, random()::FLOAT] FROM range(200) t(i);

statement ok
CREATE INDEX explain_idx ON explain_docs USING FAISS (embedding);

query II
EXPLAIN SELECT id, array_distance(embedding, [1.0, 0.0, 0.0]::FLOAT[3]) AS dist
FROM explain_docs ORDER BY dist LIMIT 2;
----
physical_plan	<REGEX>:.*ANN_INDEX_SCAN.*type: Flat.*

statement ok
DROP INDEX explain_idx;

statement ok
DROP TABLE explain_docs;

# ========================================
# Overfetch multiplier setting (issue #25)
# ========================================

statement ok
SET ann_overfetch_multiplier = 5;

statement ok
RESET ann_overfetch_multiplier;

# Clean up
statement ok
DROP INDEX faiss_idx;

statement ok
DROP INDEX prod_faiss;

statement ok
DROP TABLE docs;

statement ok
DROP TABLE products;

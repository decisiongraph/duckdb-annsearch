# name: test/sql/diskann_optimizer.test
# description: Test ANN optimizer rewrite (ORDER BY array_distance LIMIT k)
# group: [diskann]

require ann

# Create table with vectors
statement ok
CREATE TABLE docs (id INT, embedding FLOAT[3]);

statement ok
INSERT INTO docs VALUES
  (1, [1.0, 0.0, 0.0]),
  (2, [0.0, 1.0, 0.0]),
  (3, [0.0, 0.0, 1.0]),
  (4, [0.5, 0.5, 0.0]),
  (5, [0.0, 0.5, 0.5]);

# Create DISKANN index on embedding column
statement ok
CREATE INDEX docs_idx ON docs USING DISKANN (embedding);

# ORDER BY array_distance LIMIT k should be rewritten to use index scan
# The optimizer detects: LIMIT -> ORDER BY -> PROJECTION(array_distance) -> GET
# and rewrites to use the ANN index scan instead of full table scan
query IR
SELECT id, array_distance(embedding, [1.0, 0.0, 0.0]::FLOAT[3]) AS dist
FROM docs
ORDER BY dist
LIMIT 3;
----
1	0.0
4	0.70710677
5	1.2247449

# Search near [0.5, 0.5, 0.0]
query IR
SELECT id, array_distance(embedding, [0.5, 0.5, 0.0]::FLOAT[3]) AS dist
FROM docs
ORDER BY dist
LIMIT 3;
----
4	0.0
1	0.70710677
2	0.70710677

# ========================================
# WHERE + ORDER BY + LIMIT: filtered ANN search
# ========================================

# Add a category column for filtering
statement ok
CREATE TABLE products (id INT, category VARCHAR, embedding FLOAT[3]);

statement ok
INSERT INTO products VALUES
  (1, 'electronics', [1.0, 0.0, 0.0]),
  (2, 'electronics', [0.9, 0.1, 0.0]),
  (3, 'clothing', [0.0, 1.0, 0.0]),
  (4, 'clothing', [0.0, 0.9, 0.1]),
  (5, 'electronics', [0.5, 0.5, 0.0]),
  (6, 'clothing', [0.0, 0.0, 1.0]);

statement ok
CREATE INDEX prod_idx ON products USING DISKANN (embedding);

# Filter to only electronics, nearest to [1,0,0]
query I
SELECT id
FROM products
WHERE category = 'electronics'
ORDER BY array_distance(embedding, [1.0, 0.0, 0.0]::FLOAT[3])
LIMIT 2;
----
1
2

# Filter to only clothing, nearest to [0,1,0]
query I
SELECT id
FROM products
WHERE category = 'clothing'
ORDER BY array_distance(embedding, [0.0, 1.0, 0.0]::FLOAT[3])
LIMIT 2;
----
3
4

statement ok
DROP INDEX prod_idx;

statement ok
DROP TABLE products;

# ========================================
# ann_search() with oversample parameter
# ========================================

# oversample=3 should fetch 3x results from index
# After external WHERE, user still gets enough rows
query I
SELECT count(*) FROM ann_search('docs', 'docs_idx', [1.0, 0.0, 0.0], 2, oversample := 3);
----
5

# Without oversample, only k results
query I
SELECT count(*) FROM ann_search('docs', 'docs_idx', [1.0, 0.0, 0.0], 2);
----
2

# ========================================
# ann_search_batch: multiple queries at once
# ========================================

# Batch search with 2 queries, k=2 each
# DiskANN returns squared L2 distances
query IIR
SELECT query_idx, id, _distance
FROM ann_search_batch('docs', 'docs_idx', [[1.0, 0.0, 0.0], [0.0, 1.0, 0.0]], 2)
ORDER BY query_idx, _distance, id;
----
0	1	0.0
0	4	0.5
1	2	0.0
1	5	0.5

# Batch search: verify total result count = num_queries * k
query I
SELECT count(*) FROM ann_search_batch('docs', 'docs_idx', [[1.0, 0.0, 0.0], [0.0, 1.0, 0.0], [0.0, 0.0, 1.0]], 2);
----
6

# Clean up
statement ok
DROP INDEX docs_idx;

statement ok
DROP TABLE docs;

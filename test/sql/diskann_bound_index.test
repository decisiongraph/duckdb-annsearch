# name: test/sql/diskann_bound_index.test
# description: Test DISKANN BoundIndex persistence across restart
# group: [diskann]

require ann

# Use a temporary file for persistence testing
load __TEST_DIR__/diskann_bound.db

# ========================================
# Session 1: Create and populate
# ========================================

statement ok
CREATE TABLE vectors (id INT, embedding FLOAT[3]);

statement ok
INSERT INTO vectors VALUES
  (1, [1.0, 0.0, 0.0]),
  (2, [0.0, 1.0, 0.0]),
  (3, [0.0, 0.0, 1.0]);

statement ok
CREATE INDEX idx ON vectors USING DISKANN (embedding);

statement ok
INSERT INTO vectors VALUES (4, [0.5, 0.5, 0.0]);

query I
SELECT count(*) FROM vectors;
----
4

statement ok
CHECKPOINT;

# ========================================
# Session 2: Reopen and verify
# ========================================

restart

query I
SELECT count(*) FROM vectors;
----
4

query I
SELECT count(*) FROM duckdb_indexes() WHERE index_name = 'idx';
----
1

statement ok
INSERT INTO vectors VALUES (5, [0.0, 0.5, 0.5]);

query I
SELECT count(*) FROM vectors;
----
5

statement ok
DELETE FROM vectors WHERE id = 3;

query I
SELECT count(*) FROM vectors;
----
4

statement ok
CHECKPOINT;

# ========================================
# Session 3: Reopen again and verify
# ========================================

restart

query I
SELECT count(*) FROM vectors;
----
4

query I
SELECT count(*) FROM vectors WHERE id = 3;
----
0

query I
SELECT count(*) FROM duckdb_indexes() WHERE index_name = 'idx';
----
1

statement ok
INSERT INTO vectors VALUES (6, [0.7, 0.7, 0.0]);

query I
SELECT count(*) FROM vectors;
----
5

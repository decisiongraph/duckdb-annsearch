# name: test/sql/diskann_basic.test
# description: Test basic DiskANN BoundIndex functionality
# group: [diskann]

require ann

# Create table with vectors
statement ok
CREATE TABLE vectors (id INT, embedding FLOAT[3]);

statement ok
INSERT INTO vectors VALUES
  (1, [1.0, 0.0, 0.0]),
  (2, [0.0, 1.0, 0.0]),
  (3, [0.0, 0.0, 1.0]);

# Create DISKANN index
statement ok
CREATE INDEX test_idx ON vectors USING DISKANN (embedding);

# Verify index exists
query I
SELECT count(*) FROM duckdb_indexes() WHERE index_name = 'test_idx';
----
1

# Search for nearest to [1,0,0]
query II
SELECT row_id, distance FROM diskann_index_scan('vectors', 'test_idx', [1.0, 0.0, 0.0], 2) ORDER BY distance;
----
0	0.0
2	2.0

# Search and JOIN back to table
query II
SELECT v.id, s.distance
FROM diskann_index_scan('vectors', 'test_idx', [1.0, 0.0, 0.0], 3) s
JOIN vectors v ON v.rowid = s.row_id
ORDER BY s.distance;
----
1	0.0
2	2.0
3	2.0

# Insert more vectors and search again
statement ok
INSERT INTO vectors VALUES (4, [0.5, 0.5, 0.0]);

query II
SELECT v.id, s.distance
FROM diskann_index_scan('vectors', 'test_idx', [1.0, 0.0, 0.0], 2) s
JOIN vectors v ON v.rowid = s.row_id
ORDER BY s.distance;
----
1	0.0
4	0.5

# Drop index
statement ok
DROP INDEX test_idx;

# Verify index is gone
query I
SELECT count(*) FROM duckdb_indexes() WHERE index_name = 'test_idx';
----
0

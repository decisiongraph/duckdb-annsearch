# name: test/sql/faiss_bind_after_restart.test
# description: Regression test: FAISS indexes must be Bind'd after restart
# group: [faiss]
#
# Bug: FAISS indexes existed in the catalog after restart but weren't
# materialized (Bind'd), causing "index not found" or silent failures
# in faiss_index_scan, ann_search, ann_search_batch, optimizer rewrite,
# and ann_index_info. Fixed by adding indexes.Bind() calls for
# FaissIndex::TYPE_NAME in all code paths.

require ann

load __TEST_DIR__/faiss_bind_regression.db

# ========================================
# Setup: create table, FAISS index, checkpoint
# ========================================

statement ok
CREATE TABLE items (id INT, vec FLOAT[3]);

statement ok
INSERT INTO items VALUES
  (1, [1.0, 0.0, 0.0]),
  (2, [0.0, 1.0, 0.0]),
  (3, [0.0, 0.0, 1.0]),
  (4, [0.5, 0.5, 0.0]),
  (5, [0.0, 0.5, 0.5]);

statement ok
CREATE INDEX faiss_idx ON items USING FAISS (vec);

# Sanity: all paths work before restart
query II
SELECT i.id, s.distance
FROM faiss_index_scan('items', 'faiss_idx', [1.0, 0.0, 0.0], 1) s
JOIN items i ON i.rowid = s.row_id;
----
1	0.0

statement ok
CHECKPOINT;

# ========================================
# Restart — all indexes are now unbound
# ========================================

restart

# ----------------------------------------
# Path 1: faiss_index_scan (faiss_index.cpp)
# ----------------------------------------
query II
SELECT i.id, s.distance
FROM faiss_index_scan('items', 'faiss_idx', [1.0, 0.0, 0.0], 2) s
JOIN items i ON i.rowid = s.row_id
ORDER BY s.distance;
----
1	0.0
4	0.5

# ----------------------------------------
# Path 2: ann_search (ann_search.cpp)
# ----------------------------------------
query II
SELECT id, _distance
FROM ann_search('items', 'faiss_idx', [1.0, 0.0, 0.0]::FLOAT[3], 2)
ORDER BY _distance;
----
1	0.0
4	0.5

# ----------------------------------------
# Path 3: ann_search_batch (ann_search.cpp)
# ----------------------------------------
query III
SELECT query_idx, id, _distance
FROM ann_search_batch('items', 'faiss_idx', [[1.0, 0.0, 0.0], [0.0, 1.0, 0.0]], 1)
ORDER BY query_idx;
----
0	1	0.0
1	2	0.0

# ----------------------------------------
# Path 4: optimizer rewrite (ann_optimizer.cpp)
# ORDER BY array_distance(...) LIMIT k → FAISS index scan
# ----------------------------------------
query IR
SELECT id, array_distance(vec, [1.0, 0.0, 0.0]::FLOAT[3]) AS dist
FROM items
ORDER BY dist
LIMIT 2;
----
1	0.0
4	0.70710677

# ----------------------------------------
# Path 5: ann_index_info (ann_list.cpp)
# Must return stats, not zeros, proving Bind materialized the index
# ----------------------------------------
query IIIIIII
SELECT name, engine, table_name, num_vectors, num_deleted, memory_bytes > 0 AS has_mem, quantized
FROM ann_index_info()
WHERE name = 'faiss_idx';
----
faiss_idx	FAISS	items	5	0	true	false
